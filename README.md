# Vana Data Refiner for Unwrapped Spotify Contribution Proofs

This repository is a customized version of the Vana Data Refinement template, specifically designed to process and refine output data from the `unwrapped-proof-of-contribution` system. It transforms the JSON-based proof results into a normalized and queryable SQLite database, suitable for the Vana ecosystem.

## Overview

This data refiner takes the `results.json` file generated by the Unwrapped Spotify proof of contribution system and transforms it into a structured SQLite database. The process involves:

1.  **Parsing Input**: Reading the `results.json` file which contains details about a Spotify data contribution, its validation status, score, and various attributes.
2.  **Data Transformation**: Mapping the input JSON data to a predefined relational schema. This includes separating different aspects of the proof (main details, attributes, points breakdown, source file metadata) into distinct but related tables.
3.  **Database Creation**: Storing the transformed data in a libSQL (SQLite compatible) database.
4.  **Encryption**: Symmetrically encrypting the resulting SQLite database file using a key derived from the original file's encryption key.
5.  **IPFS Upload (Optional)**: If configured, the encrypted database and its schema definition are uploaded to IPFS.

The refined, encrypted database can then be registered with the Vana Data Registry, making the structured proof information queryable by permitted entities within the Vana ecosystem.

## Refined Database Schema

The refinement process generates a SQLite database with the following main tables:

*   **`unwrapped_proofs`**: Stores the core information for each proof, such as `file_id`, `dlp_id`, validity, scores, and basic metadata.
*   **`proof_attributes`**: Contains detailed attributes from valid proofs, like `track_count`, `total_minutes_listened`, `unique_artist_count`, etc. Linked to `unwrapped_proofs`.
*   **`points_breakdown_scores`**: Stores the breakdown of points (volume, diversity, history) for a contribution. Linked to `proof_attributes`.
*   **`source_file_metadata`**: Contains metadata about the original encrypted data file processed by the proof system, including its source URL and checksums. Linked to `unwrapped_proofs`.

For detailed column information, refer to `refiner/models/refined.py`.

## Project Structure

- `refiner/`: Contains the main refinement logic
    - `refine.py`: Core refinement implementation
    - `config.py`: Environment variables and settings (customized for Unwrapped proofs)
    - `__main__.py`: Entry point for the refinement execution
    - `models/`: Pydantic and SQLAlchemy data models
        - `unrefined.py`: Pydantic models for the input `results.json`
        - `refined.py`: SQLAlchemy models for the output SQLite database schema
    - `transformer/`: Data transformation logic
        - `unwrapped_transformer.py`: Transforms Unwrapped proof data to the refined schema
    - `utils/`: Utility functions for encryption, IPFS upload, etc.
- `input/`: Directory where the input `results.json` (or similar) file should be placed
- `output/`: Contains refined outputs:
    - `schema.json`: SQLite schema definition (generated)
    - `db.libsql`: SQLite database file (generated, unencrypted)
    - `db.libsql.pgp`: Encrypted SQLite database file (generated)
    - `output.json`: JSON file containing the `refinement_url` (IPFS or local file path) and schema details.
- `Dockerfile`: Defines the container image for the refinement task
- `requirements.txt`: Python package dependencies

## Getting Started

1.  **Clone/Fork this Repository**: This repository contains the refiner logic tailored for Unwrapped.
2.  **Input Data**: Place the `results.json` file (or a similarly structured JSON file) generated by the `unwrapped-proof-of-contribution` system into the `input/` directory.
3.  **Environment Variables**:
    *   Create a `.env` file in the root of the project or set environment variables directly.
    *   The most important ones for local testing are `REFINEMENT_ENCRYPTION_KEY` (any string for testing) and optionally `PINATA_API_KEY` and `PINATA_API_SECRET` if you want to upload to IPFS via Pinata.
    *   See the "Environment Variables" section below for more details.
4.  **Build and Test**: Follow the "Local Development" instructions.

### Environment Variables

Create a `.env` file in the project root or set these environment variables:

```dotenv
# Local directories where inputs and outputs are found.
# When running on the Vana refinement service, these will be /input and /output.
INPUT_DIR=input
OUTPUT_DIR=output

# This key is derived from the user file's original encryption key,
# automatically injected into the container by the Vana refinement service.
# When developing locally, any non-empty string can be used here for testing.
REFINEMENT_ENCRYPTION_KEY=your_test_encryption_key_here_for_local_dev

# Schema details (defaults are set in refiner/config.py for Unwrapped)
# SCHEMA_NAME="Unwrapped Spotify Contribution Proof"
# SCHEMA_VERSION="1.0.0"
# SCHEMA_DESCRIPTION="Schema for refined Unwrapped Spotify listening data contribution proofs."
# SCHEMA_DIALECT="sqlite"

# Optional, required if using https://pinata.cloud (IPFS pinning service)
# If not provided, IPFS uploads will be skipped and output.refinement_url will be a local file:// path.
# PINATA_API_KEY=your_pinata_api_key
# PINATA_API_SECRET=your_pinata_api_secret
```

## Local Development

To run the refinement locally for testing:

**1. Install Dependencies:**
```bash
pip install --no-cache-dir -r requirements.txt
```

**2. Prepare Input:**
Place your `results.json` (or equivalent) from the `unwrapped-proof-of-contribution` output into the `input/` directory of this project.

**3. Run with Python:**
Make sure your `.env` file is configured or environment variables are set.
```bash
python -m refiner
```

**4. (Alternatively) Run with Docker:**

First, build the Docker image:
```bash
docker build -t unwrapped-refiner .
```

Then, run the container. Remember to replace `your_test_encryption_key_here_for_local_dev` with an actual string if `REFINEMENT_ENCRYPTION_KEY` is not in your `.env` file or environment.
If using Pinata, also pass `PINATA_API_KEY` and `PINATA_API_SECRET`.

```bash
# Example without Pinata (output URL will be local file path)
docker run \
  --rm \
  --volume $(pwd)/input:/input \
  --volume $(pwd)/output:/output \
  --env REFINEMENT_ENCRYPTION_KEY="your_test_encryption_key_here_for_local_dev" \
  unwrapped-refiner

# Example with Pinata
# docker run \
#   --rm \
#   --volume $(pwd)/input:/input \
#   --volume $(pwd)/output:/output \
#   --env REFINEMENT_ENCRYPTION_KEY="your_test_encryption_key_here_for_local_dev" \
#   --env PINATA_API_KEY="your_pinata_api_key" \
#   --env PINATA_API_SECRET="your_pinata_api_secret" \
#   unwrapped-refiner
```

After execution, check the `output/` directory for `db.libsql` (the SQLite database), `db.libsql.pgp` (the encrypted database), `schema.json`, and `output.json`.

## Contributing

This refiner is specifically tailored for Unwrapped.
If you have suggestions for improving the Vana Data Refinement template itself, please refer to the [vana-data-refinement-template repository](https://github.com/vana-com/vana-data-refinement-template). For issues or improvements related to this Unwrapped-specific refiner, please open an issue or submit a pull request in this repository.

## License

[MIT License](LICENSE)